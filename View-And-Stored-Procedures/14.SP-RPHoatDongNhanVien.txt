create PROCEDURE [dbo].[sp_HoatDongNhanVien]
@MANV int,
@DATEFROM DATETIME,
@DATETO DATETIME
AS
BEGIN
    -- Tạo bảng tạm để lưu kết quả
    CREATE TABLE #TEMP (
        THANGNAM NVARCHAR(7),
        NGAY DATETIME,
        MAPHIEU NVARCHAR(10),
        LOAIPHIEU NVARCHAR(10),
        HOTENKH NVARCHAR(100),
        TENVT NVARCHAR(50),
        SOLUONG INT,
        DONGIA DECIMAL(18, 2)
    );

    -- Thêm dữ liệu từ PhieuNhap vào bảng tạm
    INSERT INTO #TEMP
    SELECT FORMAT(PN.NGAY,'MM-yyyy') AS THANGNAM,
				PN.NGAY, 
				PN.MAPN AS MAPHIEU,
				N'Nhập' AS LOAIPHIEU,
				null as HOTENKH,
				TENVT, 
				SOLUONG,
				DONGIA
		FROM (SELECT NGAY, 
					MAPN,
					TENKHO = ( SELECT TENKHO FROM Kho WHERE P.MAKHO = Kho.MAKHO )
				FROM PhieuNhap AS P
				WHERE NGAY BETWEEN @DATEFROM AND @DATETO 
				AND MANV = @MANV )PN,
				CTPN,
				(SELECT MAVT, TENVT FROM Vattu ) VT
		WHERE PN.MAPN =CTPN.MAPN
		AND VT.MAVT = CTPN.MAVT

    -- Thêm dữ liệu từ PhieuXuat vào bảng tạm
    INSERT INTO #TEMP
    SELECT FORMAT(PX.NGAY,'MM-yyyy') AS THANGNAM,
				PX.NGAY, 
				PX.MAPX AS MAPHIEU,
				N'Xuất' AS LOAIPHIEU,
				HOTENKH,
				TENVT, 
				SOLUONG,
				DONGIA
		FROM (SELECT NGAY, 
					MAPX,
					P.HOTENKH,
					TENKHO = ( SELECT TENKHO FROM Kho WHERE P.MAKHO = Kho.MAKHO )
				
				FROM PhieuXuat AS P
				WHERE NGAY BETWEEN @DATEFROM AND @DATETO 
				AND MANV = @MANV )PX,
				CTPX,
				(SELECT MAVT, TENVT FROM Vattu ) VT
		WHERE PX.MAPX =CTPX.MAPX
		AND VT.MAVT = CTPX.MAVT

    -- Truy vấn kết quả từ bảng tạm và sắp xếp
    SELECT * FROM #TEMP
    ORDER BY NGAY, MAPHIEU, TENVT;

    -- Xóa bảng tạm
    DROP TABLE #TEMP;
END;